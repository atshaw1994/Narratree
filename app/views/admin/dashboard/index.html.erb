<div class="section-container" style="min-width: 80%;">
    <div class="section-container-header">
        <h2>Admin Dashboard</h2>
    </div>
    <div class="section-container-body">
        <div id="admin-tabs" data-controller="admin-tabs" style="width: 100%;">
            <div class="admin-tab-header-flex" style="display: flex; align-items: center; justify-content: space-between; gap: 1em; max-height: 70vh;">
                <div class="admin-tab-buttons" style="display: flex; gap: 0.5em;">
                    <button type="button" class="admin-tab-btn active" data-admin-tabs-target="tabBtn" data-tab="users" data-action="click->admin-tabs#switch">Users</button>
                    <button type="button" class="admin-tab-btn" data-admin-tabs-target="tabBtn" data-tab="pending" data-action="click->admin-tabs#switch">Pending Approvals</button>
                    <button type="button" class="admin-tab-btn" data-admin-tabs-target="tabBtn" data-tab="articles" data-action="click->admin-tabs#switch">Articles</button>
                </div>
                <div class="search-bar-container" style="flex-grow: 1; max-width: 80%;">
                    <%= text_field_tag :admin_query, params[:admin_query],
                        placeholder: "Search users, articles, authors...",
                        class: "search-input",
                        data: { action: "input->admin-tabs#search", admin_tabs_target: "searchInput" }
                    %>
                </div>
            </div>
            <div class="admin-tab-content" id="users-tab" data-admin-tabs-target="tabContent" style="display: block;">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Picture</th>
                            <th data-action="click->admin-tabs#sort" data-admin-tabs-column="user-id"><span>User Id</span><span class="sort-arrow" data-admin-tabs-target="userIdArrow"></span></th>
                            <th data-action="click->admin-tabs#sort" data-admin-tabs-column="username"><span>Username</span><span class="sort-arrow" data-admin-tabs-target="usernameArrow"></span></th>
                            <th data-action="click->admin-tabs#sort" data-admin-tabs-column="first-name"><span>First Name</span><span class="sort-arrow" data-admin-tabs-target="firstNameArrow"></span></th>
                            <th data-action="click->admin-tabs#sort" data-admin-tabs-column="last-name"><span>Last Name</span><span class="sort-arrow" data-admin-tabs-target="lastNameArrow"></span></th>
                            <th data-action="click->admin-tabs#sort" data-admin-tabs-column="created-at"><span>Created At</span><span class="sort-arrow" data-admin-tabs-target="createdAtArrow"></span></th>
                            <th data-action="click->admin-tabs#sort" data-admin-tabs-column="updated-at"><span>Updated At</span><span class="sort-arrow" data-admin-tabs-target="updatedAtArrow"></span></th>
                            <th data-action="click->admin-tabs#sort" data-admin-tabs-column="encrypted-password"><span>Encrypted Password</span><span class="sort-arrow" data-admin-tabs-target="encryptedPasswordArrow"></span></th>
                            <th data-action="click->admin-tabs#sort" data-admin-tabs-column="warnings"><span>Warnings</span><span class="sort-arrow" data-admin-tabs-target="warningsArrow"></span></th>
                            <th data-action="click->admin-tabs#sort" data-admin-tabs-column="role"><span>Role</span><span class="sort-arrow" data-admin-tabs-target="roleArrow"></span></th>
                            <th>Approved</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% User.all.each do |user| %>
                            <tr>
                                <td>
                                    <% if user.profile_picture.attached? %>
                                        <%= image_tag user.profile_picture, class: "profile-pic-small" %>
                                    <% else %>
                                        <span class="material-symbols-rounded default-user-icon">account_circle</span>
                                    <% end %>
                                </td>
                                <td><%= user.id %></td>
                                <td><%= link_to user.username, user_path(user) %></td>
                                <td><%= user.first_name %></td>
                                <td><%= user.last_name %></td>
                                <td><%= user.created_at %></td>
                                <td><%= user.updated_at %></td>
                                <td><%= user.encrypted_password.present? ? "Set" : "Unset" %></td>
                                <td><%= user.warnings_count %></td>
                                <td><%= user.role %></td>
                                <td>
                                    <input type="checkbox" <%= 'checked' if user.approved? %> readonly style="pointer-events: none;" />
                                </td>
                                <td style="display: flex; gap: 0.5em; align-items: center;">
                                <form id="warn-user-form-<%= user.id %>" action="<%= warn_admin_user_path(user) %>" method="post" style="display:none;">
                                    <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                                    <input type="hidden" name="admin_message">
                                </form>
                                <button type="button"
                                        class="btn btn-sm btn-warning"
                                        title="Warn user"
                                        onclick="
                                            var msg = prompt('Message to user:');
                                            if (msg !== null && msg.trim() !== '') {
                                                var f = document.getElementById('warn-user-form-<%= user.id %>');
                                                f.admin_message.value = msg;
                                                f.submit();
                                            }
                                        ">
                                    <span class="material-symbols-rounded" style="font-size: 20px; color: #b71c1c;">warning</span>
                                </button>
                                <%= button_to admin_user_path(user), method: :delete, data: { confirm: 'Are you sure you want to delete this user?' }, class: 'btn btn-sm btn-danger' do %>
                                    <span class="material-symbols-rounded" style="font-size: 20px; color: #fff;">delete</span>
                                <% end %>
                                </td>
                            </tr>
                        <% end %>
                    </tbody>
                </table>
            </div>
            <div class="admin-tab-content" id="pending-tab" data-admin-tabs-target="tabContent" style="display: none;">
                <h3>Pending User Approvals</h3>
                <% pending_users = User.where(approved: false) %>
                <% if pending_users.any? %>
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>First Name</th>
                                <th>Last Name</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% pending_users.each do |user| %>
                                <tr>
                                    <td><%= user.username %></td>
                                    <td><%= user.email %></td>
                                    <td><%= user.first_name %></td>
                                    <td><%= user.last_name %></td>
                                    <td style="display: flex; gap: 0.5em; align-items: center;">
                                        <%= button_to approve_admin_user_path(user), method: :patch, class: 'btn btn-sm btn-success', data: { confirm: 'Approve this user?' } do %>
                                            <span class="material-symbols-rounded" style="font-size: 20px; color: #388e3c;">check_circle</span> Approve
                                        <% end %>
                                        <%= button_to reject_admin_user_path(user), method: :delete, class: 'btn btn-sm btn-danger', data: { confirm: 'Reject and delete this user?' } do %>
                                            <span class="material-symbols-rounded" style="font-size: 20px; color: #b71c1c;">cancel</span> Reject
                                        <% end %>
                                    </td>
                                </tr>
                            <% end %>
                        </tbody>
                    </table>
                <% else %>
                    <p>No users are currently awaiting approval.</p>
                <% end %>
            </div>
            <div class="admin-tab-content" id="articles-tab" data-admin-tabs-target="tabContent" style="display: none;">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th data-action="click->admin-tabs#sort" data-admin-tabs-column="article-id"><span>Article Id</span><span class="sort-arrow" data-admin-tabs-target="articleIdArrow"></span></th>
                            <th data-action="click->admin-tabs#sort" data-admin-tabs-column="title"><span>Title</span><span class="sort-arrow" data-admin-tabs-target="titleArrow"></span></th>
                            <th data-action="click->admin-tabs#sort" data-admin-tabs-column="author"><span>Author</span><span class="sort-arrow" data-admin-tabs-target="authorArrow"></span></th>
                            <th data-action="click->admin-tabs#sort" data-admin-tabs-column="created-at"><span>Created At</span><span class="sort-arrow" data-admin-tabs-target="createdAtArrow"></span></th>
                            <th data-action="click->admin-tabs#sort" data-admin-tabs-column="updated-at"><span>Updated At</span><span class="sort-arrow" data-admin-tabs-target="updatedAtArrow"></span></th>
                            <th data-action="click->admin-tabs#sort" data-admin-tabs-column="comments"><span>Comments</span><span class="sort-arrow" data-admin-tabs-target="commentsArrow"></span></th>
                            <th data-action="click->admin-tabs#sort" data-admin-tabs-column="photos"><span>Photos</span><span class="sort-arrow" data-admin-tabs-target="photosArrow"></span></th>
                            <th data-action="click->admin-tabs#sort" data-admin-tabs-column="likes"><span>Likes</span><span class="sort-arrow" data-admin-tabs-target="likesArrow"></span></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% Article.all.each do |article| %>
                            <tr>
                                <td><%= article.id %></td>
                                <td><%= link_to article.title, article_path(article) %></td>
                                <td><%= link_to article.user.username, user_path(article.user) %></td>
                                <td><%= article.created_at %></td>
                                <td><%= article.updated_at %></td>
                                <td><%= article.comments.count %></td>
                                <td><%= article.photos.attached? ? article.photos.count : 0 %></td>
                                <td><%= article.article_likes.count %></td>
                                <td>
                                  <%= link_to 'Edit', edit_article_path(article), class: 'btn btn-sm btn-primary', style: 'margin-right: 0.5em;' %>
                                  <%= link_to 'Delete', article_path(article), method: :delete, data: { confirm: 'Are you sure?' }, class: 'btn btn-sm btn-danger' %>
                                </td>
                            </tr>
                        <% end %>
                    </tbody>
                </table>
            </div>
            
        </div>
    </div>
</div>
