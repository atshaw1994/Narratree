<div class="user-profile">
    <%= render partial: "shared/section_container", locals: {
        style: "width: fit-content;",
        header: content_tag(:div) do
            safe_join([
                (if current_user && current_user != @user
                    following = current_user.following.include?(@user)
                    link_to("#",
                        class: "new-article-button",
                        style: "margin-right: 1em;",
                        title: (following ? 'Unfollow User' : 'Follow User'),
                        data: {
                            controller: "follow",
                            follow_user_id_value: @user.id,
                            follow_following_value: following,
                            follow_follow_url_value: follow_user_path(@user),
                            follow_unfollow_url_value: unfollow_user_path(@user),
                            action: "click->follow#toggleFollow"
                        },
                        "data-follow-target" => "button"
                    ) do
                        content_tag(:span, (following ? 'person_remove' : 'person_add'), class: "material-symbols-rounded", "data-follow-target" => "icon")
                    end
                end),
                content_tag(:h2, "#{@user.first_name} #{@user.last_name}")
            ].compact)
        end,
        body: content_tag(:div, class: "profile-section-container-body", style: "display: flex; flex-direction: column; align-items: center;") do
            content_tag(:div, style: "text-align: left;") do
                safe_join([
                    content_tag(:div, style: "display: flex; flex-direction: column; align-items: center;") do
                        safe_join([
                            form_with(model: @user, url: user_path(@user), method: :patch, id: "profile-pic-form", multipart: true) do |form|
                                form.file_field(:profile_picture, class: "hidden-file-input") +
                                content_tag(:div, id: "profile-pic-container") do
                                    if @user.profile_picture.attached?
                                        image_tag(@user.profile_picture, id: "profile-pic-uploader", class: "profile-pic-large", style: "margin-left: 0; cursor: pointer;", title: "Change Profile Picture")
                                    else
                                        content_tag(:span, "account_circle", class: "material-symbols-rounded default-user-icon", id: "profile-pic-uploader")
                                    end
                                end
                            end
                        ])
                    end,
                    content_tag(:div, style: "display: flex; flex-direction: column; align-items: center; margin-top: 1.5em;") do
                        safe_join([
                            content_tag(:h4, "Username:"),
                            content_tag(:p, @user.username),
                            content_tag(:h4, "Email:"),
                            content_tag(:p, @user.email),
                            content_tag(:h4, "Role:"),
                            content_tag(:p) do
                                case @user.role
                                when "owner"
                                    "Owner, Admin, Moderator, User"
                                when "admin"
                                    "Admin, Moderator, User"
                                when "moderator"
                                    "Moderator, User"
                                else
                                    "User"
                                end
                            end,
                            content_tag(:h4, "Followers:"),
                            content_tag(:p, @user.followers.count),
                            content_tag(:h4, "Member Since:"),
                            content_tag(:p, @user.created_at.strftime("%B %d, %Y")),
                            (if current_user == @user
                                link_to('Edit Profile', edit_user_registration_path, class: 'form-submit-button', style: 'margin: 0; text-decoration: none;')
                            end)
                        ].compact)
                    end
                ].compact)
            end
        end
    } %>
    <div class="section-container profile-article-list-container">
        <div class="section-container-header">
            <h2>Articles</h2>
        </div>
        <div class="section-container-body">
            <% if @articles.count > 0%>
                <ul>
                    <% @articles.each do |article| %>
                        <li>
                            <div class="card article-card-grid">
                                <%= link_to article_path(article), class: "article-card-link" do %>
                                    <div class="article-card-main">
                                        <h3 class="article-card-title"><%= article.title %></h3>
                                        <div class="article-card-author">
                                            by <em><%= article.user.username %></em>
                                        </div>
                                    </div>
                                <% end %>
                                <% if current_user && current_user == article.user %>
                                    <%= link_to article_path(article), class: "user-interaction-btn delete-btn", title: "Delete Article",
                                    data: { turbo_method: :delete, turbo_confirm: "Are you sure?" } do %>
                                        <span class="material-symbols-rounded">delete</span>
                                    <% end %>
                                <% end %>
                            </div>
                        </li>
                    <% end %>
                </ul>
            <% else %>
                <p><em>This user hasn't written any articles.</em></p>
            <% end %>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
    const profilePicUploader = document.getElementById('profile-pic-uploader');
    const hiddenFileInput = document.querySelector('.hidden-file-input');
    
    if (profilePicUploader && hiddenFileInput) {
        // When the user clicks the visible image/icon, click the hidden input
        profilePicUploader.addEventListener('click', () => {
        hiddenFileInput.click();
        });

        // When the user selects a file, automatically submit the form
        hiddenFileInput.addEventListener('change', () => {
        document.getElementById('profile-pic-form').submit();
        });
    }
    });
</script>